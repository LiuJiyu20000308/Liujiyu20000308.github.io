---
layout: post
title: CSAPP-2: 程序的机器级表示
date: 2023-12-07 16:23 +0800
tags: [CSAPP, 汇编]
toc: true
---

# 程序的机器级表示

## 程序编码概论

### 术语介绍

假设一个C程序有两个文件p1.c和p2.c，我们使用gcc编译这些代码，会经过以下步骤：
1. **C预处理**扩展源代码，插入所有用#include命令指定的文件，并扩展所有用#define声明指定的宏；
2. **编译器**产生两个源文件的汇编代码，名字分别为p1.s和p2.s；
3. **汇编器**将汇编代码转化为二进制**目标代码**文件p1.o和p2.o；
4. **链接器**将目标代码文件和实现库函数的代码合并，并产生最终的可执行文件p。

代码形式分为两种：
1. 机器代码：byte-level的文件，包括目标代码以及可执行代码文件，目标代码中包含所有指令的二进制表示，但是还没有填入全局值的地址。
2. 汇编代码：是机器代码的文字表述。

对于机器级编程来说，有两种抽象尤为重要：
1. 第一种是由 **指令集体系结构或指令集架构(Instruction Set Architecture, ISA)** 来定义机器级程序的格式和行为，它定义了处理器状态、指令的格式以及每条指令对状态的影响。大多数ISA，包括x86-64，将程序的行为描述成好像每条指令都是按顺序执行的。
2. 第二种是机器级程序使用的内存地址是虚拟地址，提供的内存模型看上去是一个非常大的字节数组，存储器系统的实际实现是将多个硬件存储器和操作系统软件组合起来，在后面第九章会讲到。

在整个编译过程中，编译器会完成大部分的工作，将C语言提供的相对抽象的执行模型表示的程序转化为汇编代码，其主要特点是它用可读性更好的文本格式表示。

x86-64的机器代码和C代码差别非常大，一些通常对C语言程序员隐藏的处理器状态都是可见的：
1. **程序计数器**(通常称为PC，在x86-64中庸用%rip表示)给出将要执行的下一条指令在内存中的地址。
2. **整数寄存器文件**包含16个命名的位置，分别存储64位的值。这些寄存器可以存储地址或整数数据。有的寄存器被用来记录重要的程序状态，而其他的寄存器用来保存临时数据，例如过程的参数和局部变量或返回值。
3. **条件码寄存器**保存着最近执行的算术或逻辑指令的状态信息
4. 一组**向量寄存器**可以存放一个或多个整数或浮点数值。

虽然C语言提供了模型，可以在内存中声明和分配各种数据类型的对象，但是机器代码只是简单地将内存看成一个很大的按字节寻址的数组，**C语言中的聚合数据类型，例如数组和结构不存在于机器级代码**，即使对于标量数据类型，汇编代码也不区分符号数与无符号数，不区分各种类型的指针，甚至不区分指针和整数。

程序内存包含：程序的可执行机器代码，操作系统需要的一些信息，用来管理过程调用和返回的运行时栈，以及用户分配的内存块。程序内存用虚拟地址来寻址，例如x86-64的虚拟地址是由64位的字来表示的，操作系统负责管理虚拟地址空间，将虚拟地址翻译成实际处理器内存中的物理地址。

一条机器指令只执行一个非常基本的操作，编译器必须产生这些指令的序列，从而实现程序结构。

### 代码示例